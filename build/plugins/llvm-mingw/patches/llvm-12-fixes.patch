This file is part of MXE. See LICENSE.md for licensing information.

Contains ad hoc patches for cross building.

From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Kleis Auke Wolthuizen <github@kleisauke.nl>
Date: Tue, 5 May 2020 14:56:18 +0200
Subject: [PATCH 1/2] Add mingw/{include,lib} to system includes/libraries

Similar to GCC's default --with-native-system-header-dir for MinGW-w64.

diff --git a/clang/lib/Driver/ToolChains/MinGW.cpp b/clang/lib/Driver/ToolChains/MinGW.cpp
index 1111111..2222222 100644
--- a/clang/lib/Driver/ToolChains/MinGW.cpp
+++ b/clang/lib/Driver/ToolChains/MinGW.cpp
@@ -421,6 +421,7 @@ toolchains::MinGW::MinGW(const Driver &D, const llvm::Triple &Triple,
   getFilePaths().push_back(
       (Base + Arch + llvm::sys::path::get_separator() + "lib").str());
   getFilePaths().push_back(Base + "lib");
+  getFilePaths().push_back(Base + "mingw/lib");
   // openSUSE
   getFilePaths().push_back(Base + Arch + "/sys-root/mingw/lib");
 
@@ -573,6 +574,7 @@ void toolchains::MinGW::AddClangSystemIncludeArgs(const ArgList &DriverArgs,
   addSystemInclude(DriverArgs, CC1Args,
                    Base + Arch + llvm::sys::path::get_separator() + "include");
   addSystemInclude(DriverArgs, CC1Args, Base + "include");
+  addSystemInclude(DriverArgs, CC1Args, Base + "mingw/include");
 }
 
 void toolchains::MinGW::AddClangCXXStdlibIncludeArgs(

From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Kleis Auke Wolthuizen <github@kleisauke.nl>
Date: Fri, 26 Mar 2021 09:20:00 +0100
Subject: [PATCH 2/2] [LLD] [COFF] Ensure exported MinGW symbols are kept during
 the GC pass

See: https://github.com/mstorsjo/llvm-mingw/issues/188

diff --git a/lld/COFF/Driver.cpp b/lld/COFF/Driver.cpp
index 1111111..2222222 100644
--- a/lld/COFF/Driver.cpp
+++ b/lld/COFF/Driver.cpp
@@ -1162,6 +1162,11 @@ void LinkerDriver::maybeExportMinGWSymbols(const opt::InputArgList &args) {
     if (!exporter.shouldExport(def))
       return;
 
+    if (!def->isGCRoot) {
+      def->isGCRoot = true;
+      config->gcroot.push_back(def);
+    }
+
     Export e;
     e.name = def->getName();
     e.sym = def;
diff --git a/lld/COFF/MinGW.cpp b/lld/COFF/MinGW.cpp
index 1111111..2222222 100644
--- a/lld/COFF/MinGW.cpp
+++ b/lld/COFF/MinGW.cpp
@@ -123,7 +123,7 @@ void AutoExporter::addWholeArchive(StringRef path) {
 }
 
 bool AutoExporter::shouldExport(Defined *sym) const {
-  if (!sym || !sym->isLive() || !sym->getChunk())
+  if (!sym || !sym->getChunk())
     return false;
 
   // Only allow the symbol kinds that make sense to export; in particular,
